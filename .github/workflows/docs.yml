name: Build & publish Lean docs

on:
  push:
    branches: [ main ]    # change to your default branch if needed
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

env:
  PROJECT_NAME: "LeanMath"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install system prerequisites
        run: |
          sudo apt-get update
          sudo apt-get install -y build-essential pkg-config curl git python3

      - name: Install elan (Lean toolchain manager)
        shell: bash
        run: |
          curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh
          echo "$HOME/.elan/bin" >> $GITHUB_PATH
          elan --version

      - name: Install requested toolchain (from lean-toolchain)
        shell: bash
        run: |
          # ensure elan is in PATH
          export PATH="$HOME/.elan/bin:$PATH"
          # read the toolchain file and install the exact toolchain
          TOOLCHAIN=$(cat lean-toolchain)
          echo "Installing toolchain: $TOOLCHAIN"
          elan toolchain install --default "$TOOLCHAIN"
          elan show

      - name: Setup cache for elan and lake build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.elan
            ./.lake
            ./lake-packages
          key: ${{ runner.os }}-lean-${{ hashFiles('**/lean-toolchain') }}-${{ hashFiles('**/lakefile.toml') }}
          restore-keys: |
            ${{ runner.os }}-lean-

      - name: lake update (fetch dependencies)
        env:
          PATH: ${{ runner.env.PATH }}
        run: |
          export PATH="$HOME/.elan/bin:$PATH"
          lake update

      - name: Build package then docs
        env:
          PATH: ${{ runner.env.PATH }}
        run: |
          export PATH="$HOME/.elan/bin:$PATH"
          # 1) build the package (ensure it compiles)
          lake build ${PROJECT_NAME}
          # 2) build docs (doc-gen integration)
          lake build ${PROJECT_NAME}:docs

      - name: Debug doc output location
        run: |
          echo "Listing .lake/build/doc..."
          find . -type d -path "*/.lake/build/doc*" -maxdepth 6 -print || true
          echo "List files under .lake/build/doc (if present):"
          find . -path "*/.lake/build/doc/*" -maxdepth 6 -print || true

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./.lake/build/doc   # change this if your docs are elsewhere
          keep_files: false