name: Build & publish Lean docs

on:
  push:
    branches: [ main ]    # change to your default branch if needed
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

env:
  PROJECT_NAME: "LeanMath"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install system prerequisites (ensure curl & coreutils present)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          # install curl, sleep (coreutils), ca-certificates and other build deps
          sudo apt-get install -y --no-install-recommends \
            build-essential pkg-config curl git python3 ca-certificates coreutils wget

      - name: Verify system tools are available
        shell: bash
        run: |
          set -euo pipefail
          # Check and verify critical tools
          command -v curl >/dev/null 2>&1 && echo "✓ curl found" || (echo "curl missing!"; exit 1)
          command -v sleep >/dev/null 2>&1 && echo "✓ sleep found" || (echo "sleep missing!"; exit 1)
          command -v wget >/dev/null 2>&1 && echo "✓ wget found" || (echo "wget missing!"; exit 1)

      - name: Install elan (Lean toolchain manager) (non-interactive)
        shell: bash
        run: |
          set -euo pipefail
          # prefer curl if available, otherwise use wget
          if command -v curl >/dev/null 2>&1; then
            curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y
          elif command -v wget >/dev/null 2>&1; then
            wget -qO- https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y
          else
            echo "Neither curl nor wget available to download elan; aborting" >&2
            exit 1
          fi
          # source elan environment to make it available immediately
          if [ -f "$HOME/.elan/env" ]; then
            # shellcheck disable=SC1090
            source "$HOME/.elan/env"
          fi
          # make elan available to later steps
          echo "$HOME/.elan/bin" >> $GITHUB_PATH
          elan --version || true

      - name: Install requested toolchain (from lean-toolchain)
        shell: bash
        run: |
          set -euo pipefail
          # ensure elan is in PATH
          export PATH="$HOME/.elan/bin:$PATH"
          # read the toolchain file and install the exact toolchain
          if [ -f lean-toolchain ]; then
            TOOLCHAIN=$(cat lean-toolchain)
            echo "Installing toolchain: $TOOLCHAIN"
            elan toolchain install "$TOOLCHAIN"
          else
            echo "lean-toolchain not found; elan will use default" >&2
          fi
          elan show || true

      - name: Setup cache for elan and lake build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.elan
            ./.lake
            ./lake-packages
          key: ${{ runner.os }}-lean-${{ hashFiles('**/lean-toolchain') }}-${{ hashFiles('**/lakefile.toml') }}
          restore-keys: |
            ${{ runner.os }}-lean-

      - name: Setup git and SSH for large clones
        shell: bash
        run: |
          set -euo pipefail
          # configure git for large repos and better performance
          git config --global http.postBuffer 524288000
          git config --global http.maxRequestBuffer 100M
          git config --global core.compression 0
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          # use HTTPS instead of SSH to avoid key issues
          git config --global url."https://github.com/".insteadOf "git://github.com/"
          echo "Git configuration complete"

      - name: lake update (fetch dependencies)
        shell: bash
        run: |
          set -euo pipefail
          export PATH="$HOME/.elan/bin:$PATH"
          # retry lake update up to 3 times to handle transient network issues
          for i in {1..3}; do
            echo "Attempt $i of 3..."
            if lake update; then
              break
            fi
            if [ $i -lt 3 ]; then
              echo "Failed, retrying in 20 seconds..."
              /bin/sleep 20
            else
              echo "lake update failed after 3 attempts"
              exit 1
            fi
          done

      - name: Build package
        shell: bash
        run: |
          set -euo pipefail
          export PATH="$HOME/.elan/bin:$PATH"
          lake build ${PROJECT_NAME}

      - name: Generate HTML documentation
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p .lake/build
          
          # Read the Lean file and escape HTML
          LEAN_CODE=$(cat LeanMath/Basic.lean | sed 's/&/\&amp;/g; s/</\&lt;/g; s/>/\&gt;/g; s/"/\&quot;/g')
          
          cat > .lake/build/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <meta charset="UTF-8">
            <title>LeanMath - Basic</title>
            <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/styles/atom-one-dark.min.css">
            <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.9.0/highlight.min.js"></script>
            <style>
              body {
                font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
                margin: 0;
                padding: 20px;
                background: #1e1e1e;
                color: #d4d4d4;
                line-height: 1.6;
              }
              .container {
                max-width: 900px;
                margin: 0 auto;
                background: #252526;
                padding: 30px;
                border-radius: 8px;
              }
              h1 {
                color: #4ec9b0;
                border-bottom: 2px solid #4ec9b0;
                padding-bottom: 10px;
              }
              pre {
                background: #1e1e1e;
                padding: 15px;
                border-radius: 6px;
                overflow-x: auto;
                border-left: 4px solid #4ec9b0;
              }
              code {
                font-family: 'Courier New', monospace;
                font-size: 14px;
              }
            </style>
          </head>
          <body>
            <div class="container">
              <h1>LeanMath.Basic</h1>
              <p>Lean 4 module: Propositions, Proofs, and Logical Reasoning</p>
              <pre><code class="language-lean">EOF
          
          echo "$LEAN_CODE" >> .lake/build/index.html
          
          cat >> .lake/build/index.html << 'EOF'
          </code></pre>
              <script>
                hljs.highlightAll();
              </script>
            </div>
          </body>
          </html>
          EOF
          
          echo "HTML documentation generated at .lake/build/index.html"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./.lake/build