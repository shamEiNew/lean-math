name: Build & publish Lean docs

on:
  push:
    branches: [ main ]    # change to your default branch if needed
  workflow_dispatch:

permissions:
  contents: write
  pages: write
  id-token: write

env:
  PROJECT_NAME: "LeanMath"

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Install system prerequisites (ensure curl & coreutils present)
        shell: bash
        run: |
          set -euo pipefail
          sudo apt-get update
          # install curl, sleep (coreutils), ca-certificates and other build deps
          sudo apt-get install -y --no-install-recommends \
            build-essential pkg-config curl git python3 ca-certificates coreutils wget

      - name: Verify system tools are available
        shell: bash
        run: |
          set -euo pipefail
          # Check and verify critical tools
          command -v curl >/dev/null 2>&1 && echo "✓ curl found" || (echo "curl missing!"; exit 1)
          command -v sleep >/dev/null 2>&1 && echo "✓ sleep found" || (echo "sleep missing!"; exit 1)
          command -v wget >/dev/null 2>&1 && echo "✓ wget found" || (echo "wget missing!"; exit 1)

      - name: Install elan (Lean toolchain manager) (non-interactive)
        shell: bash
        run: |
          set -euo pipefail
          # prefer curl if available, otherwise use wget
          if command -v curl >/dev/null 2>&1; then
            curl -sSf https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y
          elif command -v wget >/dev/null 2>&1; then
            wget -qO- https://raw.githubusercontent.com/leanprover/elan/master/elan-init.sh | sh -s -- -y
          else
            echo "Neither curl nor wget available to download elan; aborting" >&2
            exit 1
          fi
          # source elan environment to make it available immediately
          if [ -f "$HOME/.elan/env" ]; then
            # shellcheck disable=SC1090
            source "$HOME/.elan/env"
          fi
          # make elan available to later steps
          echo "$HOME/.elan/bin" >> $GITHUB_PATH
          elan --version || true

      - name: Install requested toolchain (from lean-toolchain)
        shell: bash
        run: |
          set -euo pipefail
          # ensure elan is in PATH
          export PATH="$HOME/.elan/bin:$PATH"
          # read the toolchain file and install the exact toolchain
          if [ -f lean-toolchain ]; then
            TOOLCHAIN=$(cat lean-toolchain)
            echo "Installing toolchain: $TOOLCHAIN"
            elan toolchain install "$TOOLCHAIN"
          else
            echo "lean-toolchain not found; elan will use default" >&2
          fi
          elan show || true

      - name: Setup cache for elan and lake build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ~/.elan
            ./.lake
            ./lake-packages
          key: ${{ runner.os }}-lean-${{ hashFiles('**/lean-toolchain') }}-${{ hashFiles('**/lakefile.toml') }}
          restore-keys: |
            ${{ runner.os }}-lean-

      - name: Setup git and SSH for large clones
        shell: bash
        run: |
          set -euo pipefail
          # configure git for large repos and better performance
          git config --global http.postBuffer 524288000
          git config --global http.maxRequestBuffer 100M
          git config --global core.compression 0
          git config --global http.lowSpeedLimit 0
          git config --global http.lowSpeedTime 999999
          # use HTTPS instead of SSH to avoid key issues
          git config --global url."https://github.com/".insteadOf "git://github.com/"
          echo "Git configuration complete"

      - name: lake update (fetch dependencies)
        shell: bash
        run: |
          set -euo pipefail
          export PATH="$HOME/.elan/bin:$PATH"
          # retry lake update up to 3 times to handle transient network issues
          for i in {1..3}; do
            echo "Attempt $i of 3..."
            if lake update; then
              break
            fi
            if [ $i -lt 3 ]; then
              echo "Failed, retrying in 20 seconds..."
              /bin/sleep 20
            else
              echo "lake update failed after 3 attempts"
              exit 1
            fi
          done

      - name: Build package then docs
        shell: bash
        run: |
          set -euo pipefail
          export PATH="$HOME/.elan/bin:$PATH"
          # build the package only (no docs facet)
          lake build ${PROJECT_NAME}

      - name: Debug doc output location
        shell: bash
        run: |
          set -euo pipefail
          echo "Checking for build artifacts..."
          ls -la .lake/build/ || true
          find .lake/build -type f -name '*.html' -o -name '*.json' 2>/dev/null | head -20 || echo "No HTML/JSON docs found"

      - name: Deploy to GitHub Pages
        id: deployment
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./.lake/build